<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Bot Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #25D366;
      --primary-dark: #128C7E;
      --primary-light: #DCF8C6;
      --secondary: #34B7F1;
      --dark: #075E54;
      --light: #ECE5DD;
      --white: #FFFFFF;
      --gray: #F5F7FA;
      --dark-gray: #667781;
      --error: #FF3B30;
      --success: #4CAF50;
      --warning: #FF9800;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--gray);
    }
    
    .bot-card {
      transition: all 0.3s ease;
      border-left: 4px solid var(--dark-gray);
    }
    
    .bot-card.active {
      border-left-color: var(--success);
    }
    
    .bot-card .card-body {
      position: relative;
    }
    
    .bot-status {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--dark-gray);
    }
    
    .bot-card.active .bot-status {
      background-color: var(--success);
      box-shadow: 0 0 10px var(--success);
    }
    
    .last-activity {
      font-size: 0.8rem;
      color: var(--dark-gray);
    }
    
    .qr-code-container {
      max-width: 300px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
    }
    
    .message-log {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .message {
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      max-width: 80%;
    }
    
    .incoming {
      background-color: var(--light);
      align-self: flex-start;
    }
    
    .outgoing {
      background-color: var(--primary-light);
      align-self: flex-end;
    }
    
    .typing-indicator {
      display: inline-block;
      padding: 10px;
      background-color: var(--light);
      border-radius: 15px;
      margin-bottom: 8px;
      max-width: 80%;
      align-self: flex-start;
    }
    
    .typing-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: var(--dark-gray);
      border-radius: 50%;
      margin-right: 3px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) {
      animation-delay: 0s;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
      margin-right: 0;
    }
    
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
    
    .share-link {
      word-break: break-all;
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }
    
    .bot-actions {
      display: flex;
      gap: 5px;
    }
    
    .bot-actions .btn {
      flex: 1;
    }
    
    .navbar {
      background-color: var(--primary-dark);
    }
    
    .logout-btn {
      cursor: pointer;
    }
    
    /* Novos estilos para planos */
    .plan-card {
      border-radius: 10px;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .plan-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .plan-header {
      padding: 20px;
      text-align: center;
      color: white;
    }
    
    .plan-basic .plan-header {
      background-color: #6c757d;
    }
    
    .plan-pro .plan-header {
      background-color: #007bff;
    }
    
    .plan-enterprise .plan-header {
      background-color: #28a745;
    }
    
    .plan-price {
      font-size: 2.5rem;
      font-weight: 700;
    }
    
    .plan-features {
      padding: 20px;
    }
    
    .plan-features ul {
      list-style: none;
      padding: 0;
    }
    
    .plan-features li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    
    .plan-features li:last-child {
      border-bottom: none;
    }
    
    .feature-icon {
      margin-right: 8px;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fab fa-whatsapp me-2"></i> WhatsApp Bot Manager
      </a>
      <div class="d-flex align-items-center">
        <span class="text-white me-3" id="usernameDisplay"></span>
        <i class="fas fa-sign-out-alt text-white logout-btn" id="logoutBtn"></i>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Menu de navegação -->
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="bots-tab" data-bs-toggle="tab" data-bs-target="#bots-tab-pane" type="button" role="tab">Meus Bots</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="plans-tab" data-bs-toggle="tab" data-bs-target="#plans-tab-pane" type="button" role="tab">Planos</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients-tab-pane" type="button" role="tab">Clientes</button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <!-- Aba de Bots -->
      <div class="tab-pane fade show active" id="bots-tab-pane" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="text-success">Meus Bots</h2>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newBotModal">
            <i class="fas fa-plus me-2"></i> Novo Bot
          </button>
        </div>

        <div class="row" id="botsContainer">
          <!-- Bots serão carregados aqui -->
        </div>
      </div>

      <!-- Aba de Planos -->
      <div class="tab-pane fade" id="plans-tab-pane" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="text-primary">Planos Disponíveis</h2>
          <button class="btn btn-primary" id="addPlanBtn" data-bs-toggle="modal" data-bs-target="#planModal">
            <i class="fas fa-plus me-2"></i> Novo Plano
          </button>
        </div>

        <div class="row" id="plansContainer">
          <!-- Planos serão carregados aqui -->
        </div>
      </div>

      <!-- Aba de Clientes -->
      <div class="tab-pane fade" id="clients-tab-pane" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="text-info">Clientes</h2>
          <button class="btn btn-info" id="addClientBtn" data-bs-toggle="modal" data-bs-target="#clientModal">
            <i class="fas fa-plus me-2"></i> Novo Cliente
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover" id="clientsTable">
            <thead>
              <tr>
                <th>Nome</th>
                <th>E-mail</th>
                <th>Empresa</th>
                <th>Plano</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <!-- Clientes serão carregados aqui -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Novo Bot -->
  <div class="modal fade" id="newBotModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-robot me-2"></i> Criar Novo Bot</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="botName" class="form-label">Nome do Bot</label>
            <input type="text" class="form-control" id="botName" placeholder="Ex: Atendente de Vendas">
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="geminiKey" class="form-label">Chave Gemini API</label>
              <input type="password" class="form-control" id="geminiKey" placeholder="AIza...">
            </div>
            <div class="col-md-6">
              <label for="openaiKey" class="form-label">Chave OpenAI API</label>
              <input type="password" class="form-control" id="openaiKey" placeholder="sk-...">
            </div>
          </div>
          
          <div class="mb-3">
            <label for="botIdentity" class="form-label">Personalidade do Bot</label>
            <textarea class="form-control" id="botIdentity" rows="5" placeholder="Ex: Você é o atendente da Loja X. Seja educado e responda de forma natural..."></textarea>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="startDate" class="form-label">Data de Início</label>
              <input type="datetime-local" class="form-control" id="startDate">
            </div>
            <div class="col-md-6">
              <label for="endDate" class="form-label">Data de Expiração</label>
              <input type="datetime-local" class="form-control" id="endDate">
            </div>
          </div>
          
          <div class="mb-3">
            <label for="planSelect" class="form-label">Plano Associado</label>
            <select class="form-select" id="planSelect">
              <option value="">Selecione um plano</option>
              <!-- Planos serão carregados aqui -->
            </select>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Pelo menos uma chave de API (Gemini ou OpenAI) é necessária para o bot funcionar.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" id="saveBotBtn">
            <i class="fas fa-save me-2"></i> Salvar Bot
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal QR Code -->
  <div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="qrModalTitle">Conectar WhatsApp</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <div class="qr-code-container mb-3">
            <img id="qrCodeImage" class="img-fluid">
          </div>
          <div class="alert alert-info" id="qrStatus">
            Aguardando geração do QR Code...
          </div>
          <button class="btn btn-outline-primary btn-sm mb-3" id="shareQrBtn">
            <i class="fas fa-share-alt me-2"></i> Compartilhar Bot
          </button>
          <div class="message-log d-flex flex-column" id="messageLog"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Compartilhar Bot -->
  <div class="modal fade" id="shareBotModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">Compartilhar Bot</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="clientEmail" class="form-label">E-mail do Cliente</label>
            <input type="email" class="form-control" id="clientEmail" placeholder="email@cliente.com">
          </div>
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="shareLinkInput" readonly>
            <button class="btn btn-outline-secondary" type="button" id="copyShareLinkBtn">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            O cliente poderá ver e gerenciar este bot até a data de expiração.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-primary" id="generateShareLinkBtn">
            <i class="fas fa-link me-2"></i> Gerar Link
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Bot Details -->
  <div class="modal fade" id="botDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="botDetailsTitle">Detalhes do Bot</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Informações Básicas</h6>
              <ul class="list-group mb-3">
                <li class="list-group-item d-flex justify-content-between">
                  <span>Status:</span>
                  <span id="detailStatus" class="badge bg-success">Ativo</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Criado em:</span>
                  <span id="detailCreated"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Última inicialização:</span>
                  <span id="detailLastStarted"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Último encerramento:</span>
                  <span id="detailLastStopped"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Plano:</span>
                  <span id="detailPlan"></span>
                </li>
              </ul>
              
              <div class="mb-3">
                <label for="detailStartDate" class="form-label">Data de Início</label>
                <input type="datetime-local" class="form-control" id="detailStartDate">
              </div>
              <div class="mb-3">
                <label for="detailEndDate" class="form-label">Data de Expiração</label>
                <input type="datetime-local" class="form-control" id="detailEndDate">
              </div>
            </div>
            <div class="col-md-6">
              <h6>Configurações</h6>
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="detailPreventGroups">
                <label class="form-check-label" for="detailPreventGroups">Não responder em grupos</label>
              </div>
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="detailTypingIndicator">
                <label class="form-check-label" for="detailTypingIndicator">Mostrar indicador de digitação</label>
              </div>
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="detailAllowScheduling">
                <label class="form-check-label" for="detailAllowScheduling">Permitir agendamento de mensagens</label>
              </div>
              <div class="mb-3">
                <label for="detailTypingDuration" class="form-label">Duração da digitação (segundos)</label>
                <input type="number" class="form-control" id="detailTypingDuration" min="1" max="10">
              </div>
              <div class="mb-3">
                <label for="detailResponseDelay" class="form-label">Delay de resposta (segundos)</label>
                <input type="number" class="form-control" id="detailResponseDelay" min="1" max="10">
              </div>
              <div class="mb-3">
                <label for="detailMaxResponseLength" class="form-label">Tamanho máximo da resposta (caracteres)</label>
                <input type="number" class="form-control" id="detailMaxResponseLength" min="50" max="1000">
              </div>
              <div class="mb-3">
                <label for="detailMinResponseDelay" class="form-label">Delay Mínimo (seg)</label>
                <input type="number" class="form-control" id="detailMinResponseDelay" min="0.5" max="3" step="0.1">
              </div>
              <div class="mb-3">
                <label for="detailMaxResponseDelay" class="form-label">Delay Máximo (seg)</label>
                <input type="number" class="form-control" id="detailMaxResponseDelay" min="1" max="10" step="0.5">
              </div>
              <div class="mb-3">
                <label for="detailMaxMessages" class="form-label">Máx. Msgs/Hora</label>
                <input type="number" class="form-control" id="detailMaxMessages" min="5" max="50">
              </div>
              <div class="mb-3">
                <label for="detailHumanMistakes" class="form-label">Erros Humanos (%)</label>
                <input type="number" class="form-control" id="detailHumanMistakes" min="0" max="10" step="0.5">
              </div>
              <div class="mb-3">
                <label for="detailMaxScheduledMessages" class="form-label">Máx. Msgs Agendadas</label>
                <input type="number" class="form-control" id="detailMaxScheduledMessages" min="1" max="100">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="detailBotIdentity" class="form-label">Personalidade do Bot</label>
            <textarea class="form-control" id="detailBotIdentity" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Chaves de API</label>
            <div class="input-group mb-2">
              <span class="input-group-text">Gemini</span>
              <input type="password" class="form-control" id="detailGeminiKey" placeholder="Não alterado">
            </div>
            <div class="input-group">
              <span class="input-group-text">OpenAI</span>
              <input type="password" class="form-control" id="detailOpenaiKey" placeholder="Não alterado">
            </div>
          </div>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Alterações nas configurações requerem reinicialização do bot para terem efeito.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger me-auto" id="deleteBotBtn">
            <i class="fas fa-trash me-2"></i> Excluir Bot
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-primary" id="saveDetailsBtn">
            <i class="fas fa-save me-2"></i> Salvar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Plano -->
  <div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="planModalTitle"><i class="fas fa-crown me-2"></i> Novo Plano</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="planName" class="form-label">Nome do Plano</label>
            <input type="text" class="form-control" id="planName" placeholder="Ex: Plano Profissional">
          </div>
          <div class="mb-3">
            <label for="planDescription" class="form-label">Descrição</label>
            <textarea class="form-control" id="planDescription" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="planPrice" class="form-label">Preço Mensal (R$)</label>
            <input type="number" class="form-control" id="planPrice" min="0" step="0.01">
          </div>
          <div class="mb-3">
            <label class="form-label">Recursos</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="featureMaxBots">
              <label class="form-check-label" for="featureMaxBots">
                Número máximo de bots
              </label>
              <input type="number" class="form-control mt-1" id="maxBotsValue" min="1" value="1">
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="featureApiAccess">
              <label class="form-check-label" for="featureApiAccess">
                Acesso à API
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="featureScheduling">
              <label class="form-check-label" for="featureScheduling">
                Agendamento de mensagens
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="featureAnalytics">
              <label class="form-check-label" for="featureAnalytics">
                Análises e relatórios
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="featurePrioritySupport">
              <label class="form-check-label" for="featurePrioritySupport">
                Suporte prioritário
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="featureCustomBranding">
              <label class="form-check-label" for="featureCustomBranding">
                Branding personalizado
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="savePlanBtn">
            <i class="fas fa-save me-2"></i> Salvar Plano
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Cliente -->
  <div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="clientModalTitle"><i class="fas fa-user me-2"></i> Novo Cliente</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="clientName" class="form-label">Nome</label>
                <input type="text" class="form-control" id="clientName" required>
              </div>
              <div class="mb-3">
                <label for="clientEmail" class="form-label">E-mail</label>
                <input type="email" class="form-control" id="clientEmail" required>
              </div>
              <div class="mb-3">
                <label for="clientPhone" class="form-label">Telefone</label>
                <input type="tel" class="form-control" id="clientPhone">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="clientCompany" class="form-label">Empresa</label>
                <input type="text" class="form-control" id="clientCompany">
              </div>
              <div class="mb-3">
                <label for="clientPlan" class="form-label">Plano</label>
                <select class="form-select" id="clientPlan">
                  <option value="">Selecione um plano</option>
                  <!-- Planos serão carregados aqui -->
                </select>
              </div>
              <div class="mb-3">
                <label for="clientNotes" class="form-label">Observações</label>
                <textarea class="form-control" id="clientNotes" rows="2"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-info" id="saveClientBtn">
            <i class="fas fa-save me-2"></i> Salvar Cliente
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const socket = io();
    let currentBotId = null;
    let currentQrCode = null;
    let currentBotName = null;
    const qrModal = new bootstrap.Modal('#qrModal');
    const botDetailsModal = new bootstrap.Modal('#botDetailsModal');
    const newBotModal = new bootstrap.Modal('#newBotModal');
    const shareBotModal = new bootstrap.Modal('#shareBotModal');
    const planModal = new bootstrap.Modal('#planModal');
    const clientModal = new bootstrap.Modal('#clientModal');

    // Verificar autenticação ao carregar
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
        return;
      }

      try {
        const decoded = JSON.parse(atob(token.split('.')[1]));
        document.getElementById('usernameDisplay').textContent = decoded.id;
        
        // Verificar se é admin para mostrar abas
        fetch('/api/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(response => response.json())
        .then(user => {
          if (user.isAdmin) {
            document.getElementById('plans-tab').style.display = 'block';
            document.getElementById('clients-tab').style.display = 'block';
            document.getElementById('addPlanBtn').style.display = 'block';
            document.getElementById('addClientBtn').style.display = 'block';
          } else {
            document.getElementById('plans-tab').style.display = 'none';
            document.getElementById('clients-tab').style.display = 'none';
            document.getElementById('addPlanBtn').style.display = 'none';
            document.getElementById('addClientBtn').style.display = 'none';
          }
          
          loadBots();
          loadPlans();
          loadClients();
        });
      } catch (error) {
        window.location.href = '/login';
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = '/login';
    });

    // Configurar eventos do Socket.io
    socket.on('status-update', (data) => {
      if (data.botId === currentBotId) {
        updateQRStatus(data.message, data.status);
      }
      loadBots();
    });

    socket.on('qr-update', (data) => {
      if (data.botId === currentBotId) {
        currentQrCode = data.qrImage;
        currentBotName = data.botName;
        document.getElementById('qrCodeImage').src = data.qrImage;
        document.getElementById('qrModalTitle').textContent = `Conectar ${data.botName}`;
        updateQRStatus(data.message, 'info');
        qrModal.show();
      }
    });

    socket.on('message-log', (data) => {
      if (data.botId === currentBotId) {
        if (data.type === 'typing') {
          showTypingIndicator();
        } else {
          addMessageToLog(data.message, data.type, data.timestamp);
        }
      }
    });

    // Funções principais
    async function loadBots() {
      try {
        const response = await fetch('/api/bots', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }

        const bots = await response.json();
        const container = document.getElementById('botsContainer');
        container.innerHTML = '';

        if (bots.length === 0) {
          container.innerHTML = `
            <div class="col-12">
              <div class="alert alert-info text-center">
                <i class="fas fa-robot fa-3x mb-3 text-muted"></i>
                <h4>Nenhum bot configurado</h4>
                <p>Clique no botão "Novo Bot" para começar</p>
              </div>
            </div>
          `;
          return;
        }

        bots.forEach(bot => {
          const card = document.createElement('div');
          card.className = `col-md-4 mb-4`;
          card.innerHTML = `
            <div class="card bot-card ${bot.isActive ? 'active' : ''} h-100">
              <div class="card-body">
                <div class="bot-status"></div>
                <h5 class="card-title">${bot.name}</h5>
                <p class="card-text text-muted">${bot.botIdentity.substring(0, 60)}${bot.botIdentity.length > 60 ? '...' : ''}</p>
                
                <div class="last-activity mb-3">
                  <div><i class="fas fa-calendar me-1"></i> ${formatDate(bot.startDate)} - ${formatDate(bot.endDate)}</div>
                  ${bot.Plan ? `<div><i class="fas fa-crown me-1"></i> Plano: ${bot.Plan.name}</div>` : ''}
                  ${bot.lastStartedAt ? 
                    `<div><i class="fas fa-play text-success me-1"></i> Última ativação: ${formatDate(bot.lastStartedAt)}</div>` : ''}
                  ${bot.lastStoppedAt ? 
                    `<div><i class="fas fa-stop text-danger me-1"></i> Último encerramento: ${formatDate(bot.lastStoppedAt)}</div>` : ''}
                </div>
              </div>
              <div class="card-footer bg-transparent">
                <div class="bot-actions">
                  ${bot.isActive ? 
                    `<button class="btn btn-sm btn-danger" onclick="stopBot('${bot.id}')">
                      <i class="fas fa-stop"></i> Parar
                    </button>` : 
                    `<button class="btn btn-sm btn-success" onclick="startBot('${bot.id}')">
                      <i class="fas fa-play"></i> Iniciar
                    </button>`}
                  <button class="btn btn-sm btn-primary" onclick="showBotDetails('${bot.id}')">
                    <i class="fas fa-cog"></i> Config
                  </button>
                </div>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      } catch (error) {
        console.error('Erro ao carregar bots:', error);
        showAlert('Erro ao carregar bots', 'danger');
      }
    }

    async function loadPlans() {
      try {
        const response = await fetch('/api/plans', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar planos');
        }

        const plans = await response.json();
        const container = document.getElementById('plansContainer');
        const planSelect = document.getElementById('planSelect');
        const clientPlanSelect = document.getElementById('clientPlan');
        
        container.innerHTML = '';
        planSelect.innerHTML = '<option value="">Selecione um plano</option>';
        clientPlanSelect.innerHTML = '<option value="">Selecione um plano</option>';

        if (plans.length === 0) {
          container.innerHTML = `
            <div class="col-12">
              <div class="alert alert-info text-center">
                <i class="fas fa-crown fa-3x mb-3 text-muted"></i>
                <h4>Nenhum plano configurado</h4>
                <p>Clique no botão "Novo Plano" para começar</p>
              </div>
            </div>
          `;
          return;
        }

        plans.forEach(plan => {
          // Adicionar ao container de planos
          const planCard = document.createElement('div');
          planCard.className = 'col-md-4 mb-4';
          planCard.innerHTML = `
            <div class="card plan-card h-100 plan-${plan.name.toLowerCase()}">
              <div class="plan-header">
                <h4>${plan.name}</h4>
                <div class="plan-price">R$ ${plan.price.toFixed(2)}</div>
                <small>por mês</small>
              </div>
              <div class="plan-features">
                <ul>
                  <li><i class="fas fa-check feature-icon"></i> ${plan.features.maxBots} bots</li>
                  ${plan.features.apiAccess ? '<li><i class="fas fa-check feature-icon"></i> Acesso à API</li>' : ''}
                  ${plan.features.scheduling ? '<li><i class="fas fa-check feature-icon"></i> Agendamento</li>' : ''}
                  ${plan.features.analytics ? '<li><i class="fas fa-check feature-icon"></i> Análises</li>' : ''}
                  ${plan.features.prioritySupport ? '<li><i class="fas fa-check feature-icon"></i> Suporte VIP</li>' : ''}
                  ${plan.features.customBranding ? '<li><i class="fas fa-check feature-icon"></i> Branding</li>' : ''}
                </ul>
              </div>
              <div class="card-footer bg-transparent">
                <button class="btn btn-outline-primary w-100" onclick="editPlan('${plan.id}')">
                  <i class="fas fa-edit me-2"></i> Editar
                </button>
              </div>
            </div>
          `;
          container.appendChild(planCard);

          // Adicionar aos selects
          const option = document.createElement('option');
          option.value = plan.id;
          option.textContent = `${plan.name} (R$ ${plan.price.toFixed(2)})`;
          planSelect.appendChild(option.cloneNode(true));
          clientPlanSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar planos:', error);
        showAlert('Erro ao carregar planos', 'danger');
      }
    }

    async function loadClients() {
      try {
        const response = await fetch('/api/clients', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar clientes');
        }

        const clients = await response.json();
        const tbody = document.querySelector('#clientsTable tbody');
        tbody.innerHTML = '';

        clients.forEach(client => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${client.name}</td>
            <td>${client.email}</td>
            <td>${client.company || '-'}</td>
            <td>
              ${client.Subscriptions && client.Subscriptions.length > 0 ? 
                client.Subscriptions[0].Plan.name : 'Nenhum'}
            </td>
            <td>
              <span class="badge bg-${
                client.Subscriptions && client.Subscriptions.length > 0 && 
                client.Subscriptions[0].status === 'active' ? 'success' : 'warning'
              }">
                ${client.Subscriptions && client.Subscriptions.length > 0 ? 
                  client.Subscriptions[0].status : 'inativo'}
              </span>
            </td>
            <td>
              <button class="btn btn-sm btn-outline-info" onclick="editClient('${client.id}')">
                <i class="fas fa-edit"></i>
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        showAlert('Erro ao carregar clientes', 'danger');
      }
    }

    function startBot(botId) {
      currentBotId = botId;
      fetch(`/api/start/${botId}`, { 
        method: 'POST',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            showAlert(data.error || 'Erro ao iniciar bot', 'danger');
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          showAlert('Erro ao iniciar bot', 'danger');
        });
    }

    function stopBot(botId) {
      if (confirm('Tem certeza que deseja parar este bot?')) {
        fetch(`/api/stop/${botId}`, { 
          method: 'POST',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        })
          .then(response => response.json())
          .then(() => loadBots())
          .catch(error => {
            console.error('Erro ao parar bot:', error);
            showAlert('Erro ao parar bot', 'danger');
          });
      }
    }

    function showBotDetails(botId) {
      fetch(`/api/bots/${botId}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      })
        .then(response => response.json())
        .then(bot => {
          currentBotId = botId;
          document.getElementById('botDetailsTitle').textContent = `Configuração: ${bot.name}`;
          document.getElementById('detailStatus').className = `badge bg-${bot.isActive ? 'success' : 'danger'}`;
          document.getElementById('detailStatus').textContent = bot.isActive ? 'Ativo' : 'Inativo';
          document.getElementById('detailCreated').textContent = formatDate(bot.createdAt);
          document.getElementById('detailLastStarted').textContent = bot.lastStartedAt ? formatDate(bot.lastStartedAt) : 'Nunca';
          document.getElementById('detailLastStopped').textContent = bot.lastStoppedAt ? formatDate(bot.lastStoppedAt) : 'Nunca';
          document.getElementById('detailPlan').textContent = bot.Plan ? bot.Plan.name : 'Nenhum';
          
          // Preenche os campos de data
          document.getElementById('detailStartDate').value = formatDateForInput(bot.startDate);
          document.getElementById('detailEndDate').value = formatDateForInput(bot.endDate);
          
          // Preenche as configurações
          document.getElementById('detailPreventGroups').checked = bot.settings.preventGroupResponses;
          document.getElementById('detailTypingIndicator').checked = bot.settings.typingIndicator;
          document.getElementById('detailAllowScheduling').checked = bot.settings.allowScheduling;
          document.getElementById('detailTypingDuration').value = bot.settings.typingDuration;
          document.getElementById('detailResponseDelay').value = bot.settings.responseDelay;
          document.getElementById('detailMaxResponseLength').value = bot.settings.maxResponseLength;
          document.getElementById('detailMinResponseDelay').value = bot.settings.minResponseDelay;
          document.getElementById('detailMaxResponseDelay').value = bot.settings.maxResponseDelay;
          document.getElementById('detailMaxMessages').value = bot.settings.maxMessagesPerHour;
          document.getElementById('detailHumanMistakes').value = bot.settings.humanLikeMistakes * 100;
          document.getElementById('detailMaxScheduledMessages').value = bot.settings.maxScheduledMessages;
          
          document.getElementById('detailBotIdentity').value = bot.botIdentity;
          document.getElementById('detailGeminiKey').placeholder = bot.apiKeys.gemini ? '••••••••' : 'Não configurada';
          document.getElementById('detailOpenaiKey').placeholder = bot.apiKeys.openai ? '••••••••' : 'Não configurada';
          
          document.getElementById('deleteBotBtn').onclick = () => {
            if (confirm(`Tem certeza que deseja excluir permanentemente o bot "${bot.name}"?`)) {
              deleteBot(bot.id);
            }
          };
          
          document.getElementById('saveDetailsBtn').onclick = () => {
            saveBotDetails(botId);
          };
          
          botDetailsModal.show();
        })
        .catch(error => {
          console.error('Erro ao carregar detalhes do bot:', error);
          showAlert('Erro ao carregar detalhes do bot', 'danger');
        });
    }

    function editPlan(planId) {
      fetch(`/api/plans/${planId}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      })
        .then(response => response.json())
        .then(plan => {
          document.getElementById('planModalTitle').textContent = `Editar Plano: ${plan.name}`;
          document.getElementById('planName').value = plan.name;
          document.getElementById('planDescription').value = plan.description;
          document.getElementById('planPrice').value = plan.price;
          
          // Preencher recursos
          document.getElementById('featureMaxBots').checked = true;
          document.getElementById('maxBotsValue').value = plan.features.maxBots || 1;
          document.getElementById('featureApiAccess').checked = plan.features.apiAccess || false;
          document.getElementById('featureScheduling').checked = plan.features.scheduling || false;
          document.getElementById('featureAnalytics').checked = plan.features.analytics || false;
          document.getElementById('featurePrioritySupport').checked = plan.features.prioritySupport || false;
          document.getElementById('featureCustomBranding').checked = plan.features.customBranding || false;
          
          document.getElementById('savePlanBtn').onclick = () => {
            savePlan(planId);
          };
          
          planModal.show();
        })
        .catch(error => {
          console.error('Erro ao carregar detalhes do plano:', error);
          showAlert('Erro ao carregar detalhes do plano', 'danger');
        });
    }

    function editClient(clientId) {
      fetch(`/api/clients/${clientId}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      })
        .then(response => response.json())
        .then(client => {
          document.getElementById('clientModalTitle').textContent = `Editar Cliente: ${client.name}`;
          document.getElementById('clientName').value = client.name;
          document.getElementById('clientEmail').value = client.email;
          document.getElementById('clientPhone').value = client.phone || '';
          document.getElementById('clientCompany').value = client.company || '';
          document.getElementById('clientNotes').value = client.notes || '';
          
          // Selecionar plano se existir
          if (client.Subscriptions && client.Subscriptions.length > 0) {
            document.getElementById('clientPlan').value = client.Subscriptions[0].planId;
          }
          
          document.getElementById('saveClientBtn').onclick = () => {
            saveClient(clientId);
          };
          
          clientModal.show();
        })
        .catch(error => {
          console.error('Erro ao carregar detalhes do cliente:', error);
          showAlert('Erro ao carregar detalhes do cliente', 'danger');
        });
    }

    // Função auxiliar para formatar data para input datetime-local
    function formatDateForInput(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const pad = num => num.toString().padStart(2, '0');
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    function saveBotDetails(botId) {
      const updatedBot = {
        name: document.getElementById('botDetailsTitle').textContent.replace('Configuração: ', ''),
        apiKeys: {
          gemini: document.getElementById('detailGeminiKey').value || undefined,
          openai: document.getElementById('detailOpenaiKey').value || undefined
        },
        settings: {
          preventGroupResponses: document.getElementById('detailPreventGroups').checked,
          typingIndicator: document.getElementById('detailTypingIndicator').checked,
          allowScheduling: document.getElementById('detailAllowScheduling').checked,
          typingDuration: parseInt(document.getElementById('detailTypingDuration').value),
          responseDelay: parseInt(document.getElementById('detailResponseDelay').value),
          maxResponseLength: parseInt(document.getElementById('detailMaxResponseLength').value),
          minResponseDelay: parseFloat(document.getElementById('detailMinResponseDelay').value),
          maxResponseDelay: parseFloat(document.getElementById('detailMaxResponseDelay').value),
          maxMessagesPerHour: parseInt(document.getElementById('detailMaxMessages').value),
          humanLikeMistakes: parseFloat(document.getElementById('detailHumanMistakes').value) / 100,
          maxScheduledMessages: parseInt(document.getElementById('detailMaxScheduledMessages').value)
        },
        botIdentity: document.getElementById('detailBotIdentity').value
      };

      // Atualiza as datas separadamente
      const datesUpdate = {
        startDate: document.getElementById('detailStartDate').value,
        endDate: document.getElementById('detailEndDate').value
      };

      // Primeiro atualiza as datas
      fetch(`/api/bots/${botId}/dates`, {
        method: 'PUT',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(datesUpdate)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Depois atualiza o restante das configurações
          return fetch(`/api/bots/${botId}`, {
            method: 'PUT',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(updatedBot)
          });
        } else {
          throw new Error(data.error || 'Erro ao atualizar datas');
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showAlert('Configurações salvas com sucesso!', 'success');
          loadBots();
          botDetailsModal.hide();
        } else {
          throw new Error(data.error || 'Erro ao salvar configurações');
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        showAlert('Erro ao salvar configurações: ' + error.message, 'danger');
      });
    }

    function savePlan(planId) {
      const planData = {
        name: document.getElementById('planName').value,
        description: document.getElementById('planDescription').value,
        price: parseFloat(document.getElementById('planPrice').value),
        features: {
          maxBots: parseInt(document.getElementById('maxBotsValue').value),
          apiAccess: document.getElementById('featureApiAccess').checked,
          scheduling: document.getElementById('featureScheduling').checked,
          analytics: document.getElementById('featureAnalytics').checked,
          prioritySupport: document.getElementById('featurePrioritySupport').checked,
          customBranding: document.getElementById('featureCustomBranding').checked
        }
      };

      const method = planId ? 'PUT' : 'POST';
      const url = planId ? `/api/plans/${planId}` : '/api/plans';

      fetch(url, {
        method,
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(planData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.id || data.success) {
          showAlert('Plano salvo com sucesso!', 'success');
          loadPlans();
          planModal.hide();
        } else {
          throw new Error(data.error || 'Erro ao salvar plano');
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        showAlert('Erro ao salvar plano: ' + error.message, 'danger');
      });
    }

    function saveClient(clientId) {
  const clientData = {
    name: document.getElementById('clientName').value.trim(),
    email: document.getElementById('clientEmail').value.trim(),
    phone: document.getElementById('clientPhone').value.trim(),
    company: document.getElementById('clientCompany').value.trim(),
    notes: document.getElementById('clientNotes').value.trim(),
    planId: document.getElementById('clientPlan').value
  };

  // Validação no frontend
  if (!clientData.name || !clientData.email) {
    showAlert('Nome e e-mail são obrigatórios', 'warning');
    return;
  }

  const method = clientId ? 'PUT' : 'POST';
  const url = clientId ? `/api/clients/${clientId}` : '/api/clients';

  fetch(url, {
    method,
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    },
    body: JSON.stringify(clientData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.id || data.success) {
      showAlert('Cliente salvo com sucesso!', 'success');
      loadClients();
      clientModal.hide();
    } else {
      throw new Error(data.error || 'Erro ao salvar cliente');
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    showAlert('Erro ao salvar cliente: ' + error.message, 'danger');
  });
}

    function deleteBot(botId) {
      fetch(`/api/bots/${botId}`, { 
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showAlert('Bot excluído com sucesso!', 'success');
            loadBots();
            botDetailsModal.hide();
          } else {
            throw new Error(data.error || 'Erro ao excluir bot');
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          showAlert('Erro ao excluir bot: ' + error.message, 'danger');
        });
    }

    function updateQRStatus(message, type = 'info') {
      const statusEl = document.getElementById('qrStatus');
      statusEl.className = `alert alert-${type === 'connected' ? 'success' : type === 'disconnected' ? 'danger' : 'info'}`;
      statusEl.innerHTML = `<i class="fas fa-${type === 'connected' ? 'check-circle' : type === 'disconnected' ? 'times-circle' : 'info-circle'} me-2"></i>${message}`;
    }

    function showTypingIndicator() {
      const logEl = document.getElementById('messageLog');
      const existingTyping = logEl.querySelector('.typing-indicator');
      if (existingTyping) existingTyping.remove();
      
      const typingEl = document.createElement('div');
      typingEl.className = 'typing-indicator';
      typingEl.innerHTML = `
        <div class="d-flex justify-content-between small mb-1">
          <strong>Cliente</strong>
          <span class="text-muted">Digitando...</span>
        </div>
        <div class="d-flex align-items-center">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      `;
      logEl.appendChild(typingEl);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function addMessageToLog(message, type, timestamp) {
      const logEl = document.getElementById('messageLog');
      const typingEl = logEl.querySelector('.typing-indicator');
      if (typingEl) typingEl.remove();
      
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type === 'incoming' ? 'incoming' : 'outgoing'}`;
      messageEl.innerHTML = `
        <div class="d-flex justify-content-between small mb-1">
          <strong>${type === 'incoming' ? 'Cliente' : 'Bot'}</strong>
          <span class="text-muted">${timestamp}</span>
        </div>
        <div>${message}</div>
      `;
      logEl.appendChild(messageEl);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('pt-BR');
    }

    function showAlert(message, type) {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show`;
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.prepend(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    // Eventos dos botões
    document.getElementById('saveBotBtn').addEventListener('click', () => {
      const name = document.getElementById('botName').value.trim();
      const geminiKey = document.getElementById('geminiKey').value.trim();
      const openaiKey = document.getElementById('openaiKey').value.trim();
      const botIdentity = document.getElementById('botIdentity').value.trim();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const planId = document.getElementById('planSelect').value;

      if (!name || (!geminiKey && !openaiKey)) {
        showAlert('Preencha pelo menos o nome e uma chave de API', 'warning');
        return;
      }

      fetch('/api/bots', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          name,
          apiKeys: { gemini: geminiKey, openai: openaiKey },
          botIdentity,
          startDate,
          endDate,
          planId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          newBotModal.hide();
          loadBots();
          showAlert('Bot criado com sucesso!', 'success');
        } else {
          throw new Error(data.error || 'Erro ao criar bot');
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        showAlert('Erro ao criar bot: ' + error.message, 'danger');
      });
    });

    document.getElementById('shareQrBtn').addEventListener('click', () => {
      shareBotModal.show();
    });

    document.getElementById('generateShareLinkBtn').addEventListener('click', () => {
      const email = document.getElementById('clientEmail').value.trim();
      if (!email) {
        showAlert('Digite um e-mail válido', 'warning');
        return;
      }

      fetch(`/api/bots/${currentBotId}/share`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({ email })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('shareLinkInput').value = data.shareLink;
          showAlert('Bot compartilhado com sucesso!', 'success');
        } else {
          throw new Error(data.error || 'Erro ao compartilhar bot');
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        showAlert('Erro ao compartilhar bot: ' + error.message, 'danger');
      });
    });

    document.getElementById('copyShareLinkBtn').addEventListener('click', () => {
      const shareLinkInput = document.getElementById('shareLinkInput');
      shareLinkInput.select();
      document.execCommand('copy');
      showAlert('Link copiado para a área de transferência!', 'success');
    });

    document.getElementById('addPlanBtn').addEventListener('click', () => {
      document.getElementById('planModalTitle').textContent = 'Novo Plano';
      document.getElementById('planName').value = '';
      document.getElementById('planDescription').value = '';
      document.getElementById('planPrice').value = '';
      document.getElementById('featureMaxBots').checked = true;
      document.getElementById('maxBotsValue').value = 1;
      document.getElementById('featureApiAccess').checked = false;
      document.getElementById('featureScheduling').checked = false;
      document.getElementById('featureAnalytics').checked = false;
      document.getElementById('featurePrioritySupport').checked = false;
      document.getElementById('featureCustomBranding').checked = false;
      
      document.getElementById('savePlanBtn').onclick = () => {
        savePlan();
      };
    });

    document.getElementById('addClientBtn').addEventListener('click', () => {
      document.getElementById('clientModalTitle').textContent = 'Novo Cliente';
      document.getElementById('clientName').value = '';
      document.getElementById('clientEmail').value = '';
      document.getElementById('clientPhone').value = '';
      document.getElementById('clientCompany').value = '';
      document.getElementById('clientNotes').value = '';
      document.getElementById('clientPlan').value = '';
      
      document.getElementById('saveClientBtn').onclick = () => {
        saveClient();
      };
    });

    document.getElementById('savePlanBtn').addEventListener('click', () => {
      savePlan();
    });

    document.getElementById('saveClientBtn').addEventListener('click', () => {
      saveClient();
    });

    // Preencher datas padrão no modal de novo bot
   // No evento de abertura do modal de novo bot
document.getElementById('newBotModal').addEventListener('show.bs.modal', async () => {
  const now = new Date();
  const startDate = now.toISOString().slice(0, 16);
  const endDate = new Date(now.setDate(now.getDate() + 30)).toISOString().slice(0, 16);
  
  document.getElementById('startDate').value = startDate;
  document.getElementById('endDate').value = endDate;

  // Carregar assinaturas disponíveis
  try {
    const response = await fetch('/api/user/subscriptions', {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    const subscriptions = await response.json();
    
    const planSelect = document.getElementById('planSelect');
    planSelect.innerHTML = '<option value="">Selecione um plano</option>';
    
    subscriptions.forEach(sub => {
      const option = document.createElement('option');
      option.value = sub.planId;
      option.textContent = `${sub.Plan.name} (Expira em ${formatDate(sub.endDate)})`;
      planSelect.appendChild(option);
    });
  } catch (error) {
    console.error('Erro ao carregar assinaturas:', error);
  }
});
  </script>
</body>
</html>

